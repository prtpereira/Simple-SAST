package org.checkmarx.codescanner.service;

import org.checkmarx.codescanner.model.Vulnerability;
import org.checkmarx.codescanner.util.security.SecurityChecker;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileInputStream;
import java.io.InputStreamReader;
import java.nio.charset.StandardCharsets;
import java.util.AbstractMap;
import java.util.ArrayList;
import java.util.List;
import java.util.concurrent.Callable;
import java.util.stream.IntStream;

public class VulnerabilityFinderCallable implements Callable<List<Vulnerability>> {

    private final String pathName;
    List<SecurityChecker> securityCheckers;

    public VulnerabilityFinderCallable(String pathName, List<SecurityChecker> securityCheckers)
    {
        this.pathName = pathName;
        this.securityCheckers = securityCheckers;
    }

    public String getPathName() {
        return pathName;
    }

    @Override
    public List<Vulnerability> call() {
        List<Vulnerability> vulnerabilities = new ArrayList<>();

        try {
            File file = new File(pathName);
            FileInputStream fiStream = new FileInputStream(file);
            InputStreamReader isReader = new InputStreamReader(fiStream, StandardCharsets.UTF_8);
            BufferedReader bufferedReader = new BufferedReader(isReader);

            String line;
            for(int lineNumber = 1; (line = bufferedReader.readLine()) != null; lineNumber++) {
                String code = line;
                int finalLineNumber = lineNumber;

                securityCheckers.forEach(securityChecker -> {
                    AbstractMap.SimpleEntry<String, Integer> detectedVulns = securityChecker.detect(code);
                    IntStream.range(0, detectedVulns.getValue()).forEach(n -> vulnerabilities.add(
                            new Vulnerability(pathName, detectedVulns.getKey(), finalLineNumber))
                    );
                });
            }

            bufferedReader.close();
            isReader.close();
            fiStream.close();

            System.out.println("Vulnerability finder task has finished successfully for file: " + pathName + " with " + vulnerabilities.size() + " vulnerabilities");
        } catch (Exception e) {
            System.err.println("An error occurred while trying to check the vulnerabilities on the source code. Error: " + e.getMessage());
        }

        return vulnerabilities;
    }


}
